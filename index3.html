<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0,user-scalable=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>index</title>
    <link rel="stylesheet" href="./src/css/global.css" />
    <link rel="stylesheet" href="./src/font_qianqian/iconfont.css" />
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="./src/js/rem.js"></script>
    <link rel="stylesheet" href="./src/css/swiper.min.css" />
    <script src="./src/js/swiper.min.js"></script>
    <script src="https://cdn.bootcss.com/iScroll/5.2.0/iscroll-probe.min.js"></script>
  </head>

  <body>
    <div id="wrapper">
      <div id="wrapper_content">
        <div class="top_nav gradientBg">
          <div class="top_search">
            <div class="loaction">
              <span>汕头</span>
              <i class="icon iconfont icon-icon_down_arrow"></i>
            </div>
            <div class="search">
              <i class="icon iconfont icon-search"></i>
              <input
                type="search"
                placeholder="搜索最近的洗车店"
                class="inputSearch"
              />
            </div>
          </div>

          <div class="swiper-container ">
            <div class="swiper-wrapper">
              <!-- <div class="swiper-slide"><a href="javascript:;;"><img src="./src/images/top_nav_slider.png"></a></div> -->
            </div>

            <div class="swiper-pagination"></div>
          </div>

          <div class="top_nav_menu">
            <a href="javascript:;;" class="active">距离最近</a>
            <a href="javascript:;;">价格最优</a>
            <a href="javascript:;;">评分最高</a>
            <a href="javascript:;;">我的收藏</a>
          </div>
        </div>

        <div class="content">
          <ul class="content_wrap">
            <li>
              <a href="javascript:;;">
                <img src="./src/images/index_content_1.png" alt="" />
                <div class="shop_info">
                  <span class="shop_name">靓车会靓车会汕头店</span>
                  <p class="shop_score">
                    <strong class="star">
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star"></i>
                    </strong>
                    <span class="score">4.7</span>
                  </p>
                </div>
              </a>
            </li>
            <li>
              <a href="javascript:;;">
                <img src="./src/images/index_content_2.png" alt="" />
                <div class="shop_info">
                  <span class="shop_name">靓车会靓车会汕头店</span>
                  <p class="shop_score">
                    <strong class="star">
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star"></i>
                    </strong>
                    <span class="score">4.7</span>
                  </p>
                </div>
              </a>
            </li>
            <li>
              <a href="javascript:;;">
                <img src="./src/images/index_content_3.png" alt="" />
                <div class="shop_info">
                  <span class="shop_name">靓车会靓车会汕头店</span>
                  <p class="shop_score">
                    <strong class="star">
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star"></i>
                    </strong>
                    <span class="score">4.7</span>
                  </p>
                </div>
              </a>
            </li>
            <li>
              <a href="javascript:;;">
                <img src="./src/images/index_content_4.png" alt="" />
                <div class="shop_info">
                  <span class="shop_name">靓车会靓车会汕头店</span>
                  <p class="shop_score">
                    <strong class="star">
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star1"></i>
                      <i class="icon iconfont icon-star"></i>
                    </strong>
                    <span class="score">4.7</span>
                  </p>
                </div>
              </a>
            </li>
          </ul>
        </div>
        <div class="pulluptorefresh">
          上拉加载更多
        </div>
      </div>
    </div>
    <div class="tabbar">
      <a class="gradient-text">
        <i class="icon iconfont icon-xiche-cuxiantiao "></i>
        <span class="gradient-text">洗车</span>
      </a>

      <a>
        <i class="icon iconfont icon-zhinanzhen"></i>
        <span>推荐</span>
      </a>

      <a>
        <i class="icon iconfont icon-wode2"></i>
        <span>我的</span>
      </a>
    </div>
  </body>
</html>

<script>
  $(function() {
    var lat, lon; //获取经纬度
    navigator.geolocation.getCurrentPosition(function(position) {
      lat = position.coords.latitude;
      lon = position.coords.longitude;
    });
    var myScroll;
    var loadingStep = 0;
    var page = 0;
    var page_size = 5; //有个bug,这个必须是5
    var cityid = 84;
    var keyword = "云轩";
    var test_str = ``;

    var content_bydistance = ``,
      content_byprice = ``,
      content_byscore = ``,
      content_byfavour = ``,
      content_bysearch = ``;

    //提前获取距离最近的店铺
    $.get(
      "http://stqqkj.com/index.php/Home/Mobile/shoplistBydistance/page/0/lon/" +
        lon +
        "/lat/" +
        lat +
        "/cityid/" +
        cityid,
      // 'http://stqqkj.com/index.php/Home/Mobile/shoplistByfavour/page/0/user_id/' +
      //                 7,
      res => {
        content_bydistance += handle_result(res);
        $(".content_wrap").html(content_bydistance);
        refresh();
      }
    );

    //搜索
    $(".inputSearch").on("keyup", function(e) {
      keyword = this.value;

      if (e.keyCode == 13) {
        $(".top_nav_menu")
          .children("a")
          .removeClass("active");

        $.get(
          "http://stqqkj.com/index.php/Home/Mobile/ShoplistBySearch/page/" +
            page +
            "/keyword/" +
            keyword +
            "/cityid/" +
            cityid,
          res => {
            var data = JSON.parse(res);
            if (data.resultCode == 0) {
              content_bysearch = ``; //每次搜索都需要重置
              content_bysearch += handle_result(res);
              if (data.data.length == 0) {
                $(".content_wrap").html(`<div class="pulluptorefresh">
                没有搜索结果
            </div>`);
        refresh();

            return;
              }
              $(".content_wrap").html(content_bysearch);
        refresh();

            }
          }
        );
      }
    });

    //加载广告图片
    $.get("http://stqqkj.com/index.php/Home/Mobile/getAd", res => {
      var res = JSON.parse(res);
      var str = ``;
      res.data.forEach(ele => {
        str += ` <div class="swiper-slide">
                            <a href="javascript:;;"><img src="${ele.image}"></a>
                        </div>`;
      });

      if (res.resultCode == 0) {
        $(".swiper-wrapper").append(str);
        setTimeout(() => {
          var swiper = new Swiper(".swiper-container", {
            pagination: {
              el: ".swiper-pagination"
            }
          });
        }, 100);
      }
    });

    $(".top_nav_menu").on("click", function(e) {
      $(e.target)
        .addClass("active")
        .siblings()
        .removeClass("active");
      // var ind = $(e.target).index();
      // var content_arr=[content_bydistance,content_byprice,content_byscore,content_byfavour]
      // $('.content').html(content_arr[ind]);

      var ele = e.target;
      switch (true) {
        case $(ele)
          .text()
          .trim() == "距离最近":
          $(".content_wrap").html(content_bydistance);
          break;

        case $(ele)
          .text()
          .trim() == "价格最优":
          if (content_byprice.length > 2) {
            $(".content_wrap").html(content_byprice);
            refresh();

            return;
          }
          $(".content_wrap").html("");
          $.get(
            "http://stqqkj.com/index.php/Home/Mobile/shoplistByprice/page/0/cityid/" +
              cityid,
            res => {
              content_byprice += handle_result(res);
              $(".content_wrap").html(content_byprice);
        refresh();

            }
          );
          break;
        case $(ele)
          .text()
          .trim() == "评分最高":
          if (content_byscore.length > 2) {
            $(".content_wrap").html(content_byscore);
            refresh();

            return;
          }
          $(".content_wrap").html("");
          $.get(
            "http://stqqkj.com/index.php/Home/Mobile/shoplistByscore/page/0/cityid/" +
              cityid,
            res => {
              content_byscore += handle_result(res);
              $(".content_wrap").html(content_byscore);
        refresh();

            }
          );
          break;
        case $(ele)
          .text()
          .trim() == "我的收藏":
          if (content_byfavour.length > 2) {
            $(".content_wrap").html(content_byfavour);
            refresh();

            return;
          }
          $(".content_wrap").html("");
          $.get(
            "http://stqqkj.com/index.php/Home/Mobile/shoplistByfavour/page/0/user_id/" +
              7,
            res => {
              content_byfavour += handle_result(res);
              $(".content_wrap").html(content_byfavour);
        refresh();

            }
          );
          break;
        default:
          break;
      }
    });
    $(".tabbar a").click(function(e) {
      var target = e.currentTarget;
      $(target)
        .addClass("gradient-text")
        .siblings()
        .removeClass("gradient-text")
        .children()
        .removeClass("gradient-text");
    });

    // iscroll
    $("#wrapper").on("touchmove", function(e) {
      e.preventDefault();
    }); //阻止浏览器默认事件

    myScroll = new IScroll("#wrapper", {
      scrollbars: true,
      mouseWheel: false,
      interactiveScrollbars: true,
      shrinkScrollbars: "scale",
      fadeScrollbars: true,
      scrollY: true,
      probeType: 2,
      bindToWrapper: true,
      preventDefault: false
    });
    myScroll.on("scroll", function() {
      if (this.maxScrollY - this.y >= 60 && loadingStep == 0) {
        //下拉后加载更多
        loadingStep = 1;
        pullUpAction();
      }
      if (this.maxScrollY - this.y <= 0) {
        loadingStep = 0;
       
      }
    });

    function pullUpAction() {
      setTimeout(() => {
        loadingStep = 0;

        if (
            //search上拉加载
          $(!".top_nav_menu")
            .children("a")
            .hasClass("active")
        ) {
            var allitems=$(".content_wrap").children().length
          page = parseInt(allitems / page_size);
            if(allitems/page_size>0){
                $(".content_wrap").html(content_bysearch+`<div class="pulluptorefresh">
                没有更多结果
            </div>`)
return;
            }
          $.get(
            "http://stqqkj.com/index.php/Home/Mobile/ShoplistBySearch/page/" +
              page +
              "/keyword/" +
              keyword +
              "/cityid/" +
              cityid,
            res => {
              var data = JSON.parse(res);
              if (data.data.length == 0) {
                $(".content_wrap").html(
                  content_bysearch +
                    `<div class="pulluptorefresh">
                没有更多结果
            </div>`
                );
        refresh();

                return;
              }
              content_bysearch += handle_result(res);
              $(".content_wrap").html(content_bysearch);
        refresh();

            }
          );
          myScroll.refresh();
        }

        $(".top_nav_menu a").each((ind, ele) => {
          if ($(ele).hasClass("active")) {
            switch (true) {
              case $(ele)
                .text()
                .trim() == "距离最近":
                page = Math.ceil(
                  $(".content_wrap").children().length / page_size
                );
                console.log(page);
                $.get(
                  "http://stqqkj.com/index.php/Home/Mobile/shoplistBydistance/page/0/lon/" +
                    lon +
                    "/lat/" +
                    lat +
                    "/cityid/" +
                    cityid,
                  res => {
                    var data = JSON.parse(res);
                    if (data.data.length == 0) {
                      $(".content_wrap").html(
                        content_bydistance +
                          `<div class="pulluptorefresh">
                没有更多结果
            </div>`
                      );
        refresh();

                      return;
                    }
                    content_bydistance += handle_result(res);
                    $(".content_wrap").html(content_bydistance);
        refresh();

                  }
                );
                break;
              case $(ele)
                .text()
                .trim() == "价格最优":
                page = Math.ceil(
                  $(".content_wrap:visible").children().length / page_size
                );
                console.log(page);
                $.get(
                  "http://stqqkj.com/index.php/Home/Mobile/shoplistByprice/page/" +
                    page +
                    "/cityid/" +
                    cityid,
                  res => {
                    var data = JSON.parse(res);
                    if (data.data.length == 0) {
                      $(".content_wrap").html(
                        content_byprice +
                          `<div class="pulluptorefresh">
                没有更多结果
            </div>`
                      );
        refresh();

                      return;
                    }
                    content_byprice += handle_result(res);
                    $(".content_wrap").html(content_byprice);
        refresh();

                  }
                );
                break;
              case $(ele)
                .text()
                .trim() == "评分最高":
                page = Math.ceil(
                  $(".content_wrap:visible").children().length / page_size
                );
                console.log(page);
                $.get(
                  "http://stqqkj.com/index.php/Home/Mobile/shoplistByscore/page/" +
                    page +
                    "/cityid/" +
                    cityid,
                  res => {
                    var data = JSON.parse(res);
                    if (data.data.length == 0) {
                      $(".content_wrap").html(
                        content_byscore +
                          `<div class="pulluptorefresh">
                没有更多结果
            </div>`
                      );
        refresh();

                      return;
                    }
                    content_byprice += handle_result(res);
                    $(".content_wrap").html(content_byscore);
        refresh();

                  }
                );
                break;
              case $(ele)
                .text()
                .trim() == "我的收藏":
                page = Math.ceil(
                  $(".content_wrap").children().length / page_size
                );
                console.log(page);
                $.get(
                  "http://stqqkj.com/index.php/Home/Mobile/ShoplistByfavour/page/" +
                    page +
                    "/user_id/7",
                  res => {
                    var data = JSON.parse(res);
                    if (data.data.length == 0) {
                      $(".content_wrap").html(
                        content_byfavour +
                          `<div class="pulluptorefresh">
                没有更多结果
            </div>`
                      );
        refresh();

                      return;
                    }
                    content_byfavour += handle_result(res);
                    $(".content_wrap").html(content_byfavour);
        refresh();

                  }
                );
                break;
              default:
                break;
            }
          }
        });
      }, 200);
      refresh();
     
    }

    function handle_result(res) {
      var res = JSON.parse(res);
      var arr = res.data;
      var str = ``;
      if (res.resultCode != 0) {
        str=`<div>没有更多数据</div>`

        return;
      }
      if (res.resultCode == 0) {
        var score = 0;
        
        arr.forEach(ele => {
          str += `
                      
                        <li>
                            <a href="javascript:;;">
                                <img src="${ele.shop_image}">
                                <div class='shop_info'><span class='shop_name'>${
                                  ele.shop_name
                                }</span>
                                    <p class='shop_score'>
                                        <strong class='star'>`;
          score = ele.score * 1;
          for (let i = 0, len = parseInt(score / 2); i < len; i++) {
            str += `<i class="icon iconfont icon-star1"></i>`;
          }
          if (score % 1 > 0) {
            str += `<i class="icon iconfont icon-star"></i>`;
          }

          str += `
                                        </strong>
                                        <span class='score'>${ele.score}</span>
                                    </p>
                                </div>
                            </a>
                        </li>`;
        });
      }

      return str;
    }

    function refresh() {
      setTimeout(function() {
        myScroll.refresh();
      }, 1000);
    }
  });
</script>
